为什么写这篇博客，作为一个Android开发者，日常使用线程池的频率相对较少，网上又许多的关于线程池的博客。真的有必要写这个东西吗？辗转思考我还是决定要写一篇关于线程池的文章，因为站在不同的角度可能有不同的理解，同时别人的文章也并没有解答我想要的问题。

2022年掘金的愿望：升级到lv4,写出一篇点赞数超过100的文章，从这里开始。如果觉得文章还不错，评论、点赞、关注是对我最大的鼓励。



# 前言

在Android中，为了保证UI的流畅性，会将许多耗时的操作放到子线程中来完成。但是线程作为CPU调度的最小单位，创建、销毁和线程调度都需要较大的成本。因此线程的管理就显得尤为重要。并且，一些常用的框架比如Glide,Okhttp都有有自己的线程池配置，线程池也是Android面试过程中的高频问题。所以对于一个想要进阶高级Android开发人员来说，线程池是一个绕不开的话题。

# 线程池配置参数

线程池可以通过ThreadPoolExecutor来创建，ThreadPoolExecutor有多个构造函数，但是最终会通过this调用参数最多的这个。我们来看看。

```java
public ThreadPoolExecutor(int corePoolSize,
                              int maximumPoolSize,
                              long keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue<Runnable> workQueue,
                              ThreadFactory threadFactory,
                              RejectedExecutionHandler handler)
```

参数解析：

corePoolSize： 线程池核心线程数最大值
maximumPoolSize： 线程池最大线程数大小
keepAliveTime： 线程池中非核心线程空闲的存活时间大小，但是allowCoreThreadTimeOut(boolean value) 设置为 true 时 这个时间也会作用于核心线程。
unit： 线程空闲存活时间单位
workQueue： 线程池中的任务队列，我们提交给线程池的runnable会被存储在这个对象上。
线程池的分配遵循这样的规则：当线程池中的核心线程数量未达到最大线程数时，启动一个核心线程去执行任务；
如果线程池中的核心线程数量达到最大线程数时，那么任务会被插入到任务队列中排队等待执行；
如果在上一步骤中任务队列已满但是线程池中线程数量未达到限定线程总数，那么启动一个非核心线程来处理任务；

threadFactory： 用于设置创建线程的工厂，通过实现newThread返回一个新的线程
handler：  线城池的饱和策略事件，主要有四种类型。

# 线程池的执行流程

参数解析

向线程池提交任务有execute、submit、invokeAny 、invokeAll四种方式，但是他们最终都会被包装成调用execute的方式，这里不去探讨其他方式调用的实现。就以execute分析线程池的执行流程。

execute执行流程如下：

- 如果当前存活的线程数小于核心线程，则直接创建一个线程执行当前任务
- 如果当前核心线程数已经达到最大值且工作队列能够存储任务，那么将任务添加进入队列等待执行。
- 在核心线程数已经达到最大值的情况下，工作队列不能接受任务，如果可以创建非核心线程，那么创建非核心线程执行，否则执行任务拒绝策略。

![1639671500309](线程池执行流程.png)

## ThreadPoolExecutor关键成员

## 执行流程代码分析

核心线程和非核心线程的区别？怎么来进行维护的？

workQueue存储量无限大，这个非核心线程怎么启动？

核心线程池是如何进行维护的？非核心线程池到底会不会从workQueue取数据？

java线程池的设计理念。为什么是核心线程-->workQueue --> 非核心线程 而不是  核心线程-->非核心线程 而不是  --> workQueue  的顺序插入。

线程池的拒绝策略

线程池的异常处理

常见的几种工作队列

java提供的几种线程池配置的使用场景

Glide中的动画线程池配置合理吗？

OkHttp中的线程池是如何配置的？合理吗。



文章参考：

[面试必备：Java线程池解析](https://juejin.cn/post/6844903889678893063)

[深入理解 Java 线程池：ThreadPoolExecutor](https://juejin.cn/post/6844903475197788168)